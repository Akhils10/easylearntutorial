<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Space Shooter: V2</title>
    <style>
        body, html {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            background: #aaa;
            overflow: hidden;
        }

        canvas {
            display: block;
            margin: 50px auto;
        }
    </style>
</head>
<body>
<script>
    var WORLD_OUTER_WIDTH = 900;
    var WORLD_OUTER_HEIGHT = 500;

    var Renderer = function(width, height) {
        this.canvas = document.createElement('canvas');
        this.ctx = null;

        this.init(width, height);
    };

    Renderer.prototype.init = function(width, height){
        this.canvas.width = width;
        this.canvas.height = height;
        this.ctx = this.canvas.getContext('2d');
    };

    Renderer.prototype.render = function(entities) {
        var entity;
        var sprite;

        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

        // Render BG
        this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

        for (var i = 0, len = entities.length; i < len; i++) {
            entity = entities[i];
            sprite = entity.sprite;
            this.ctx.drawImage(sprite.img, sprite.x, sprite.y, sprite.width, sprite.height, entity.x, entity.y, entity.width, entity.height);
        }
    };

    var Entity = function(x, y, width, height, dx, dy, sprite, controller) {
        this.x = x;
        this.y = y;
        this.dx = dx;
        this.dy = dy;
        this.width = width;
        this.height = height;
        this.halfWidth = parseInt(width * 0.5, 10);
        this.halfHeight = parseInt(height * 0.5, 10);

        this.sprite = sprite;
        this.controller = controller || {};
    };

    Entity.prototype.update = function(dt) {
        if (this.controller.mouseDown) {
            var dx = this.controller.targetX - this.x;
            var dy = this.controller.targetY - this.y;
            var len = Math.sqrt(dx * dx + dy * dy);
            var _len = 1 / len;

            // HOR
            if (len < this.width) {
                this.x = this.controller.targetX - this.halfWidth;
            } else {
                this.x += dx * _len * dt * this.dx;
            }

            if (this.controller.targetX < this.width) {
                this.x = this.halfWidth;
            }

            if (this.x > WORLD_OUTER_WIDTH - this.width) {
                this.x = WORLD_OUTER_WIDTH - this.width - this.halfWidth;
            }

            // VERT
            if (len < this.height) {
                this.y = this.controller.targetY - this.halfHeight;
            } else {
                this.y += dy * _len * dt * this.dy;
            }

            if (this.controller.targetY < this.height) {
                this.y = this.halfHeight;
            }

            if (this.y > WORLD_OUTER_HEIGHT - this.height) {
                this.y = WORLD_OUTER_HEIGHT - this.height - this.halfHeight;
            }

        }
    };

    Entity.prototype.addComponent = function(componentName, component) {
        this.components[componentName] = component;
    };

    var Controller = function() {
        this.mouseDown = false;
        this.targetX = 0;
        this.targetY = 0;
    };

    Controller.componentName = 'Controller';

    Controller.prototype.bindToMouse = function(element) {
        var self = this;
        element.addEventListener('mousedown', function(e){
            self.targetX = e.offsetX;
            self.targetY = e.offsetY;
            self.mouseDown = true;
        });

        element.addEventListener('mousemove', function(e){
            self.targetX = e.offsetX;
            self.targetY = e.offsetY;
        });

        element.addEventListener('mouseup', function(e){
            self.mouseDown = false;
        });
    };

    var Sprite = function(img, x, y, width, height) {
        this.img = new Image();
        this.img.src = img;
        this.x = x;
        this.y = y;
        this.width = width;
        this.height = height;
    };

    var Game = function(renderer) {
        this.lastTime = 0;
        this.dt = 0;
        this.timeSpeed = 1;
        this.MAX_TIME = 1.0 / 60.0;

        this.isPlaying = false;

        this.entities = [];
        this.renderer = renderer;
    };

    Game.prototype.tick = function(now) {
        this.dt = (now - this.lastTime) * 0.001;
        requestAnimationFrame(this.tick.bind(this));

        if (this.dt > this.MAX_TIME) {
            this.dt = this.MAX_TIME;
        }

        for (var i = 0, len = this.entities.length; i < len; i++) {
            this.entities[i].update(this.dt);
        }

        this.renderer.render(this.entities);
    };

    Game.prototype.bindTo = function(element){
        element.appendChild(this.renderer.canvas);
    };

    Game.prototype.start = function(){
        if (!this.isPlaying) {
            this.isPlaying = true;
            this.tick(0);
        }
    };


    // - - - - - - -

    var spriteRed = new Sprite('/img/tiles.png', 32, 0, 16, 16);
    var spriteBlue = new Sprite('/img/tiles.png', 16, 0, 16, 16);
    var controller = new Controller();
    var player = new Entity(100, 100, 32, 32, 1500, 1500, spriteBlue, controller);
    var renderer = new Renderer(WORLD_OUTER_WIDTH, WORLD_OUTER_HEIGHT);
    var game = new Game(renderer);

    controller.bindToMouse(renderer.canvas);

    game.entities.push(player);
    game.bindTo(document.body);
    game.start();
</script>
</body>
</html>
